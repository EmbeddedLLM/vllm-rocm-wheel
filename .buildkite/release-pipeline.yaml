steps:
  # # aarch64 + CUDA builds
  # - label: "Build arm64 wheel - CUDA 12.9"
  #   depends_on: ~
  #   id: build-wheel-arm64-cuda-12-9
  #   agents:
  #     queue: arm64_cpu_queue_postmerge
  #   commands:
  #     # #NOTE: torch_cuda_arch_list is derived from upstream PyTorch build files here:
  #     # https://github.com/pytorch/pytorch/blob/main/.ci/aarch64_linux/aarch64_ci_build.sh#L7
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg USE_SCCACHE=1 --build-arg GIT_REPO_CHECK=1 --build-arg CUDA_VERSION=12.9.1 --build-arg torch_cuda_arch_list='8.7 8.9 9.0 10.0+PTX 12.0' --tag vllm-ci:build-image --target build --progress plain -f docker/Dockerfile ."
  #     - "mkdir artifacts"
  #     - "docker run --rm -v $(pwd)/artifacts:/artifacts_host vllm-ci:build-image bash -c 'cp -r dist /artifacts_host && chmod -R a+rw /artifacts_host'"
  #     - "bash .buildkite/scripts/upload-wheels.sh"
  #   env:
  #     DOCKER_BUILDKIT: "1"

  # # aarch64 build
  # - label: "Build arm64 CPU wheel"
  #   depends_on: ~
  #   id: build-wheel-arm64-cpu
  #   agents:
  #     queue: arm64_cpu_queue_postmerge
  #   commands:
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg GIT_REPO_CHECK=1 --build-arg VLLM_BUILD_ACL=ON --tag vllm-ci:build-image --target vllm-build --progress plain -f docker/Dockerfile.cpu ."
  #     - "mkdir artifacts"
  #     - "docker run --rm -v $(pwd)/artifacts:/artifacts_host vllm-ci:build-image bash -c 'cp -r dist /artifacts_host && chmod -R a+rw /artifacts_host'"
  #     - "bash .buildkite/scripts/upload-wheels.sh"
  #   env:
  #     DOCKER_BUILDKIT: "1"

  # # x86 + CUDA builds
  # - label: "Build wheel - CUDA 12.9"
  #   depends_on: ~
  #   id: build-wheel-cuda-12-9
  #   agents:
  #     queue: cpu_queue_postmerge
  #   commands:
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg USE_SCCACHE=1 --build-arg GIT_REPO_CHECK=1 --build-arg CUDA_VERSION=12.9.1 --tag vllm-ci:build-image --target build --progress plain -f docker/Dockerfile ."
  #     - "mkdir artifacts"
  #     - "docker run --rm -v $(pwd)/artifacts:/artifacts_host vllm-ci:build-image bash -c 'cp -r dist /artifacts_host && chmod -R a+rw /artifacts_host'"
  #     - "bash .buildkite/scripts/upload-wheels.sh"
  #   env:
  #     DOCKER_BUILDKIT: "1"

  # - label: "Build wheel - CUDA 13.0"
  #   depends_on: ~
  #   id: build-wheel-cuda-13-0
  #   agents:
  #     queue: cpu_queue_postmerge
  #   commands:
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg USE_SCCACHE=1 --build-arg GIT_REPO_CHECK=1 --build-arg CUDA_VERSION=13.0.1 --build-arg BUILD_BASE_IMAGE=nvidia/cuda:13.0.1-devel-ubuntu22.04 --tag vllm-ci:build-image --target build --progress plain -f docker/Dockerfile ."
  #     - "mkdir artifacts"
  #     - "docker run --rm -v $(pwd)/artifacts:/artifacts_host vllm-ci:build-image bash -c 'cp -r dist /artifacts_host && chmod -R a+rw /artifacts_host'"
  #     - "bash .buildkite/scripts/upload-wheels.sh"
  #   env:
  #     DOCKER_BUILDKIT: "1"

  # # Build release images (12.9)
  # - label: "Build release image (x86)"
  #   depends_on: ~
  #   id: build-release-image-x86
  #   agents:
  #     queue: cpu_queue_postmerge
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg USE_SCCACHE=1 --build-arg GIT_REPO_CHECK=1 --build-arg CUDA_VERSION=12.9.1 --build-arg FLASHINFER_AOT_COMPILE=true --build-arg INSTALL_KV_CONNECTORS=true --tag public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-$(uname -m) --target vllm-openai --progress plain -f docker/Dockerfile ."
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-$(uname -m)"
  #     # re-tag to default image tag and push, just in case arm64 build fails
  #     - "docker tag public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-$(uname -m) public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT"
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT"

  # - label: "Build release image (arm64)"
  #   depends_on: ~
  #   id: build-release-image-arm64
  #   agents:
  #     queue: arm64_cpu_queue_postmerge
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg USE_SCCACHE=1 --build-arg GIT_REPO_CHECK=1 --build-arg CUDA_VERSION=12.9.1 --build-arg FLASHINFER_AOT_COMPILE=true --build-arg torch_cuda_arch_list='8.7 8.9 9.0 10.0+PTX 12.0' --build-arg INSTALL_KV_CONNECTORS=true --tag public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-$(uname -m) --target vllm-openai --progress plain -f docker/Dockerfile ."
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-$(uname -m)"

  # # Add job to create multi-arch manifest
  # - label: "Create multi-arch manifest"
  #   depends_on:
  #     - build-release-image-x86
  #     - build-release-image-arm64
  #   id: create-multi-arch-manifest
  #   agents:
  #     queue: cpu_queue_postmerge
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "docker manifest create public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-x86_64 public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-aarch64 --amend"
  #     - "docker manifest push public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT"

  # - label: "Annotate release workflow"
  #   depends_on:
  #     - create-multi-arch-manifest
  #   id: annotate-release-workflow
  #   agents:
  #     queue: cpu_queue_postmerge
  #   commands:
  #     - "bash .buildkite/scripts/annotate-release.sh"

  # - input: "Provide Release version here"
  #   id: input-release-version
  #   fields:
  #     - text: "What is the release version?"
  #       key: release-version

  # - block: "Build CPU release image"
  #   key: block-cpu-release-image-build
  #   depends_on: ~

  # - label: "Build and publish CPU release image"
  #   depends_on: block-cpu-release-image-build
  #   agents:
  #     queue: cpu_queue_postmerge
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg GIT_REPO_CHECK=1 --build-arg VLLM_CPU_AVX512BF16=true --build-arg VLLM_CPU_AVX512VNNI=true --build-arg VLLM_CPU_AMXBF16=true --tag public.ecr.aws/q9t5s3a7/vllm-cpu-release-repo:$(buildkite-agent meta-data get release-version) --tag public.ecr.aws/q9t5s3a7/vllm-cpu-release-repo:latest --progress plain --target vllm-openai -f docker/Dockerfile.cpu ."
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-cpu-release-repo:latest"
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-cpu-release-repo:$(buildkite-agent meta-data get release-version)"
  #   env:
  #     DOCKER_BUILDKIT: "1"

  # - block: "Build arm64 CPU release image"
  #   key: block-arm64-cpu-release-image-build
  #   depends_on: ~

  # - label: "Build and publish arm64 CPU release image"
  #   depends_on: block-arm64-cpu-release-image-build
  #   agents:
  #     queue: arm64_cpu_queue_postmerge
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "DOCKER_BUILDKIT=1 docker build --build-arg max_jobs=16 --build-arg GIT_REPO_CHECK=1 --tag public.ecr.aws/q9t5s3a7/vllm-arm64-cpu-release-repo:$(buildkite-agent meta-data get release-version) --tag public.ecr.aws/q9t5s3a7/vllm-arm64-cpu-release-repo:latest --progress plain --target vllm-openai -f docker/Dockerfile.cpu ."
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-arm64-cpu-release-repo:latest"
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-arm64-cpu-release-repo:$(buildkite-agent meta-data get release-version)"
  #   env:
  #     DOCKER_BUILDKIT: "1"

  # - label: "Build and publish nightly multi-arch image to DockerHub"
  #   depends_on:
  #     - create-multi-arch-manifest
  #   if: build.env("NIGHTLY") == "1"
  #   agents:
  #     queue: cpu_queue_postmerge
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "docker pull public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-x86_64"
  #     - "docker pull public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-aarch64"
  #     - "docker tag public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-x86_64 vllm/vllm-openai:nightly-x86_64"
  #     - "docker tag public.ecr.aws/q9t5s3a7/vllm-release-repo:$BUILDKITE_COMMIT-aarch64 vllm/vllm-openai:nightly-aarch64"
  #     - "docker push vllm/vllm-openai:nightly-x86_64"
  #     - "docker push vllm/vllm-openai:nightly-aarch64"
  #     - "docker manifest create vllm/vllm-openai:nightly vllm/vllm-openai:nightly-x86_64 vllm/vllm-openai:nightly-aarch64 --amend"
  #     - "docker manifest create vllm/vllm-openai:nightly-$BUILDKITE_COMMIT vllm/vllm-openai:nightly-x86_64 vllm/vllm-openai:nightly-aarch64 --amend"
  #     - "docker manifest push vllm/vllm-openai:nightly"
  #     - "docker manifest push vllm/vllm-openai:nightly-$BUILDKITE_COMMIT"
  #     # Clean up old nightly builds (keep only last 14)
  #     - "bash .buildkite/scripts/cleanup-nightly-builds.sh"
  #   plugins:
  #     - docker-login#v3.0.0:
  #         username: vllmbot
  #         password-env: DOCKERHUB_TOKEN
  #   env:
  #     DOCKER_BUILDKIT: "1"
  #     DOCKERHUB_USERNAME: "vllmbot"

  # =============================================================================
  # ROCm Release Pipeline (x86_64 only)
  # =============================================================================
  #
  # Environment variables for ROCm builds (set via Buildkite UI or schedule):
  #   ROCM_VERSION: ROCm version (default: 7.1)
  #   ROCM_PYTHON_VERSION: Python version (default: 3.12)
  #   PYTORCH_ROCM_ARCH: GPU architectures (default: gfx90a;gfx942;gfx950;gfx1100;gfx1101;gfx1200;gfx1201;gfx1150;gfx1151)
  #   ROCM_VLLM_VERSION: vLLM version/tag (default: latest)
  #   ROCM_REUSE_BASE_WHEELS: Skip base wheels build, use previous artifacts (default: false)
  #   ROCM_PUBLISH_ONLY: Skip all builds, only publish (default: false)
  #   ROCM_PREVIOUS_BUILD_ID: Build ID to reuse artifacts from (required if ROCM_REUSE_BASE_WHEELS or ROCM_PUBLISH_ONLY)
  #   ROCM_UPLOAD_WHEELS: Upload to S3 (default: false for nightly, true for releases)
  #
  # =============================================================================

  # ROCm Input Step - Collect build configuration (manual trigger only)
  - input: "ROCm Release Build Configuration"
    key: input-rocm-config
    if: build.source == "ui"
    fields:
      - text: "ROCm Version"
        key: "rocm-version"
        default: "7.1"
        hint: "ROCm version (e.g., 7.1)"
      - text: "Python Version"
        key: "rocm-python-version"
        default: "3.12"
        hint: "Python version (e.g., 3.12)"
      - text: "vLLM Version"
        key: "rocm-vllm-version"
        default: "latest"
        hint: "vLLM tag (e.g., v0.11.2), branch (e.g., main), or 'latest'"
      - text: "GPU Architectures"
        key: "rocm-pytorch-rocm-arch"
        default: "gfx90a;gfx942;gfx950;gfx1100;gfx1101;gfx1200;gfx1201;gfx1150;gfx1151"
        hint: "Semicolon-separated GPU architectures"
      - select: "Reuse Base Wheels"
        key: "rocm-reuse-base-wheels"
        default: "false"
        options:
          - label: "No - Build fresh base wheels"
            value: "false"
          - label: "Yes - Reuse from previous build"
            value: "true"
        hint: "Skip base wheel build and reuse artifacts from previous build"
      - select: "Publish Only"
        key: "rocm-publish-only"
        default: "false"
        options:
          - label: "No - Build and optionally publish"
            value: "false"
          - label: "Yes - Skip builds, only publish"
            value: "true"
        hint: "Skip all builds, only run S3 upload step"
      - text: "Previous Build ID"
        key: "rocm-previous-build-id"
        required: false
        hint: "Build ID to download artifacts from (required if reuse-base-wheels or publish-only is true)"
      - select: "Upload Wheels to S3"
        key: "rocm-upload-wheels"
        default: "false"
        options:
          - label: "No - Build only (nightly/dev)"
            value: "false"
          - label: "Yes - Upload to S3 (release)"
            value: "true"

  # ROCm Job 1: Build ROCm Base Wheels
  - label: ":rocm: Build ROCm Base Wheels"
    id: build-rocm-base-wheels
    depends_on:
      - step: input-rocm-config
        allow_failure: true  # Allow failure so non-UI builds can proceed (input step is skipped)
    agents:
      queue: vllm-rocm-wheel
    timeout_in_minutes: 240
    commands:
      # Set configuration and build base image
      # All in one block to preserve shell variables across commands
      - |
        set -euo pipefail

        # Check if we should skip this job
        ROCM_REUSE_BASE_WHEELS="$${ROCM_REUSE_BASE_WHEELS:-}"
        if [ -z "$${ROCM_REUSE_BASE_WHEELS}" ]; then
          ROCM_REUSE_BASE_WHEELS="$$(buildkite-agent meta-data get rocm-reuse-base-wheels 2>/dev/null || echo '')"
        fi
        ROCM_PUBLISH_ONLY="$${ROCM_PUBLISH_ONLY:-}"
        if [ -z "$${ROCM_PUBLISH_ONLY}" ]; then
          ROCM_PUBLISH_ONLY="$$(buildkite-agent meta-data get rocm-publish-only 2>/dev/null || echo '')"
        fi

        if [ "$${ROCM_REUSE_BASE_WHEELS}" = "true" ] || [ "$${ROCM_PUBLISH_ONLY}" = "true" ]; then
          echo "Skipping base wheel build (ROCM_REUSE_BASE_WHEELS=$${ROCM_REUSE_BASE_WHEELS}, ROCM_PUBLISH_ONLY=$${ROCM_PUBLISH_ONLY})"
          echo "Will reuse artifacts from previous build"
          exit 0
        fi

        # Get values from meta-data (set by input step) or use defaults
        ROCM_VERSION="$$(buildkite-agent meta-data get rocm-version 2>/dev/null || echo '')"
        ROCM_VERSION="$${ROCM_VERSION:-7.1}"

        PYTHON_VERSION="$$(buildkite-agent meta-data get rocm-python-version 2>/dev/null || echo '')"
        PYTHON_VERSION="$${PYTHON_VERSION:-3.12}"

        PYTORCH_ROCM_ARCH="$$(buildkite-agent meta-data get rocm-pytorch-rocm-arch 2>/dev/null || echo '')"
        PYTORCH_ROCM_ARCH="$${PYTORCH_ROCM_ARCH:-gfx90a;gfx942;gfx950;gfx1100;gfx1101;gfx1200;gfx1201;gfx1150;gfx1151}"

        echo "========================================"
        echo "Building ROCm base wheels with:"
        echo "  ROCM_VERSION: $${ROCM_VERSION}"
        echo "  PYTHON_VERSION: $${PYTHON_VERSION}"
        echo "  PYTORCH_ROCM_ARCH: $${PYTORCH_ROCM_ARCH}"
        echo "========================================"

        # Save resolved config for later jobs
        buildkite-agent meta-data set "rocm-version" "$${ROCM_VERSION}"
        buildkite-agent meta-data set "rocm-python-version" "$${PYTHON_VERSION}"
        buildkite-agent meta-data set "rocm-pytorch-rocm-arch" "$${PYTORCH_ROCM_ARCH}"

        # Build full base image (for later vLLM build)
        DOCKER_BUILDKIT=1 docker buildx build \
          --file docker/Dockerfile.rocm_base \
          --tag rocm/vllm-dev:base-$${BUILDKITE_BUILD_NUMBER} \
          --build-arg PYTORCH_ROCM_ARCH="$${PYTORCH_ROCM_ARCH}" \
          --build-arg PYTHON_VERSION="$${PYTHON_VERSION}" \
          --load \
          .

        # Build debs stage for wheel extraction
        DOCKER_BUILDKIT=1 docker buildx build \
          --file docker/Dockerfile.rocm_base \
          --tag rocm-base-debs:$${BUILDKITE_BUILD_NUMBER} \
          --target debs \
          --build-arg PYTORCH_ROCM_ARCH="$${PYTORCH_ROCM_ARCH}" \
          --build-arg PYTHON_VERSION="$${PYTHON_VERSION}" \
          --load \
          .

      # Extract wheels from Docker image
      - |
        mkdir -p artifacts/rocm-base-wheels
        container_id=$$(docker create rocm-base-debs:$${BUILDKITE_BUILD_NUMBER})
        docker cp $${container_id}:/app/debs/. artifacts/rocm-base-wheels/
        docker rm $${container_id}
        echo "Extracted base wheels:"
        ls -lh artifacts/rocm-base-wheels/

      # Export base Docker image for reuse in vLLM build
      # Upload directly to S3 (too large for Buildkite's 5GB limit)
      - |
        mkdir -p artifacts/rocm-docker-image
        docker save rocm/vllm-dev:base-$${BUILDKITE_BUILD_NUMBER} | gzip > artifacts/rocm-docker-image/rocm-base-image.tar.gz
        echo "Docker image size:"
        ls -lh artifacts/rocm-docker-image/

        # Debug: show S3_BUCKET value
        echo "S3_BUCKET from env: $${S3_BUCKET}"

        # Upload large Docker image to S3
        # Note: S3_BUCKET should be set in cluster secrets or pipeline env
        S3_ARTIFACT_PATH="s3://$${S3_BUCKET}/buildkite-artifacts/$${BUILDKITE_PIPELINE_SLUG}/$${BUILDKITE_BUILD_NUMBER}"
        echo "Uploading Docker image to $${S3_ARTIFACT_PATH}/"
        aws s3 cp artifacts/rocm-docker-image/rocm-base-image.tar.gz "$${S3_ARTIFACT_PATH}/rocm-base-image.tar.gz"

        # Save the S3 path for downstream jobs
        buildkite-agent meta-data set "rocm-docker-image-s3-path" "$${S3_ARTIFACT_PATH}/rocm-base-image.tar.gz"
    artifact_paths:
      - "artifacts/rocm-base-wheels/*.whl"
    env:
      DOCKER_BUILDKIT: "1"
      S3_BUCKET: "vllm-rocm-wheels-embeddedllm-2"
      AWS_DEFAULT_REGION: "us-east-1"

  # ROCm Job 2: Build vLLM ROCm Wheel
  - label: ":python: Build vLLM ROCm Wheel"
    id: build-rocm-vllm-wheel
    depends_on:
      - step: build-rocm-base-wheels
        allow_failure: true  # Allow to proceed even if Job 1 was skipped
    agents:
      queue: vllm-rocm-wheel
    timeout_in_minutes: 120
    commands:
      # Download artifacts and prepare Docker image
      - |
        set -euo pipefail

        # Check if we should skip this job (publish only mode)
        ROCM_PUBLISH_ONLY="$${ROCM_PUBLISH_ONLY:-}"
        if [ -z "$${ROCM_PUBLISH_ONLY}" ]; then
          ROCM_PUBLISH_ONLY="$$(buildkite-agent meta-data get rocm-publish-only 2>/dev/null || echo '')"
        fi

        if [ "$${ROCM_PUBLISH_ONLY}" = "true" ]; then
          echo "Skipping vLLM wheel build (ROCM_PUBLISH_ONLY=$${ROCM_PUBLISH_ONLY})"
          echo "Will reuse artifacts from previous build in upload step"
          exit 0
        fi

        # Get configuration from meta-data with defaults
        ROCM_REUSE_BASE_WHEELS="$$(buildkite-agent meta-data get rocm-reuse-base-wheels 2>/dev/null || echo '')"
        ROCM_REUSE_BASE_WHEELS="$${ROCM_REUSE_BASE_WHEELS:-false}"

        ROCM_PREVIOUS_BUILD_ID="$$(buildkite-agent meta-data get rocm-previous-build-id 2>/dev/null || echo '')"

        # Download wheel artifacts from Buildkite
        if [ "$${ROCM_REUSE_BASE_WHEELS}" = "true" ] && [ -n "$${ROCM_PREVIOUS_BUILD_ID}" ]; then
          echo "Downloading wheel artifacts from previous build: $${ROCM_PREVIOUS_BUILD_ID}"
          buildkite-agent artifact download "artifacts/rocm-base-wheels/*.whl" . --build "$${ROCM_PREVIOUS_BUILD_ID}"
        else
          echo "Downloading wheel artifacts from current build"
          buildkite-agent artifact download "artifacts/rocm-base-wheels/*.whl" .
        fi

        # Download Docker image from S3 (too large for Buildkite artifacts)
        DOCKER_IMAGE_S3_PATH="$$(buildkite-agent meta-data get rocm-docker-image-s3-path 2>/dev/null || echo '')"
        if [ -z "$${DOCKER_IMAGE_S3_PATH}" ]; then
          # Fallback to default path (use previous build number if reusing)
          if [ "$${ROCM_REUSE_BASE_WHEELS}" = "true" ] && [ -n "$${ROCM_PREVIOUS_BUILD_ID}" ]; then
            DOCKER_IMAGE_S3_PATH="s3://$${S3_BUCKET}/buildkite-artifacts/$${BUILDKITE_PIPELINE_SLUG}/$${ROCM_PREVIOUS_BUILD_ID}/rocm-base-image.tar.gz"
          else
            DOCKER_IMAGE_S3_PATH="s3://$${S3_BUCKET}/buildkite-artifacts/$${BUILDKITE_PIPELINE_SLUG}/$${BUILDKITE_BUILD_NUMBER}/rocm-base-image.tar.gz"
          fi
        fi
        echo "Downloading Docker image from $${DOCKER_IMAGE_S3_PATH}"
        mkdir -p artifacts/rocm-docker-image
        aws s3 cp "$${DOCKER_IMAGE_S3_PATH}" artifacts/rocm-docker-image/rocm-base-image.tar.gz

        # Load base Docker image
        echo "Loading base Docker image..."
        gunzip -c artifacts/rocm-docker-image/rocm-base-image.tar.gz | docker load
        docker images | grep rocm/vllm-dev | head -1
        docker tag rocm/vllm-dev:base-* rocm/vllm-dev:base 2>/dev/null || docker tag $$(docker images rocm/vllm-dev --format "{{.Repository}}:{{.Tag}}" | head -1) rocm/vllm-dev:base
        docker images rocm/vllm-dev:base

        # Prepare base wheels for Docker build context
        mkdir -p docker/context/base-wheels
        touch docker/context/base-wheels/.keep
        cp artifacts/rocm-base-wheels/*.whl docker/context/base-wheels/
        echo "Base wheels for vLLM build:"
        ls -lh docker/context/base-wheels/

      # Resolve vLLM version and build wheel
      - |
        set -euo pipefail

        # Get configuration from meta-data with defaults
        ROCM_VLLM_VERSION="$$(buildkite-agent meta-data get rocm-vllm-version 2>/dev/null || echo '')"
        ROCM_VLLM_VERSION="$${ROCM_VLLM_VERSION:-latest}"

        PYTORCH_ROCM_ARCH="$$(buildkite-agent meta-data get rocm-pytorch-rocm-arch 2>/dev/null || echo '')"
        PYTORCH_ROCM_ARCH="$${PYTORCH_ROCM_ARCH:-gfx90a;gfx942}"

        # Resolve "latest" to actual version
        if [ "$${ROCM_VLLM_VERSION}" = "latest" ]; then
          echo "Fetching latest vLLM release..."
          ROCM_VLLM_VERSION=$$(curl -s https://api.github.com/repos/vllm-project/vllm/releases/latest | jq -r .tag_name)
          if [ "$${ROCM_VLLM_VERSION}" = "null" ] || [ -z "$${ROCM_VLLM_VERSION}" ]; then
            echo "WARNING: Could not fetch latest release, using main"
            ROCM_VLLM_VERSION="main"
          fi
        fi

        echo "========================================"
        echo "Building vLLM wheel with:"
        echo "  ROCM_VLLM_VERSION: $${ROCM_VLLM_VERSION}"
        echo "  PYTORCH_ROCM_ARCH: $${PYTORCH_ROCM_ARCH}"
        echo "========================================"

        # Save resolved version for later jobs
        buildkite-agent meta-data set "rocm-resolved-vllm-version" "$${ROCM_VLLM_VERSION}"

        # Build vLLM wheel
        DOCKER_BUILDKIT=1 docker build \
          --file docker/Dockerfile.rocm \
          --target export_vllm \
          --output type=local,dest=rocm-dist \
          --build-arg BASE_IMAGE=rocm/vllm-dev:base \
          --build-arg ARG_PYTORCH_ROCM_ARCH="$${PYTORCH_ROCM_ARCH}" \
          --build-arg REMOTE_VLLM=1 \
          --build-arg VLLM_REPO=https://github.com/vllm-project/vllm.git \
          --build-arg VLLM_BRANCH="$${ROCM_VLLM_VERSION}" \
          .

        echo "Built vLLM wheel:"
        ls -lh rocm-dist/*.whl

      # Repair wheel with auditwheel
      - |
        set -euo pipefail
        pip install auditwheel patchelf || true
        mkdir -p artifacts/rocm-vllm-wheel
        for wheel in rocm-dist/*.whl; do
          echo "Repairing wheel: $${wheel}"
          auditwheel repair --plat manylinux_2_35_x86_64 -w artifacts/rocm-vllm-wheel/ "$${wheel}" || \
            cp "$${wheel}" artifacts/rocm-vllm-wheel/
        done
        echo "Final vLLM wheel:"
        ls -lh artifacts/rocm-vllm-wheel/
    artifact_paths:
      - "artifacts/rocm-vllm-wheel/*.whl"
    env:
      DOCKER_BUILDKIT: "1"
      S3_BUCKET: "vllm-rocm-wheels-embeddedllm-2"
      AWS_DEFAULT_REGION: "us-east-1"

  # ROCm Job 3: Upload Wheels to S3
  - label: ":s3: Upload ROCm Wheels to S3"
    id: upload-rocm-wheels
    depends_on:
      - step: build-rocm-vllm-wheel
        allow_failure: true  # Allow to proceed even if Job 2 was skipped (publish only mode)
    agents:
      queue: vllm-rocm-wheel
    timeout_in_minutes: 60
    commands:
      # Download all wheel artifacts and run upload
      - |
        set -euo pipefail

        # Check if upload is enabled (from env var, meta-data, or release branch)
        ROCM_UPLOAD_WHEELS="$${ROCM_UPLOAD_WHEELS:-}"
        if [ -z "$${ROCM_UPLOAD_WHEELS}" ]; then
          # Try to get from meta-data (input form)
          ROCM_UPLOAD_WHEELS="$$(buildkite-agent meta-data get rocm-upload-wheels 2>/dev/null || echo '')"
        fi
        NIGHTLY="$${NIGHTLY:-}"

        # Check if branch matches release tag pattern (v1.2.3 or v1.2.3-rc1)
        IS_RELEASE_BRANCH="false"
        if [[ "$${BUILDKITE_BRANCH}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
          IS_RELEASE_BRANCH="true"
        fi

        echo "========================================"
        echo "Upload check:"
        echo "  ROCM_UPLOAD_WHEELS: $${ROCM_UPLOAD_WHEELS}"
        echo "  NIGHTLY: $${NIGHTLY}"
        echo "  BUILDKITE_BRANCH: $${BUILDKITE_BRANCH}"
        echo "  IS_RELEASE_BRANCH: $${IS_RELEASE_BRANCH}"
        echo "========================================"

        # Skip upload if not enabled
        if [ "$${ROCM_UPLOAD_WHEELS}" != "true" ] && [ "$${NIGHTLY}" != "1" ] && [ "$${IS_RELEASE_BRANCH}" != "true" ]; then
          echo "Skipping S3 upload (ROCM_UPLOAD_WHEELS != true, NIGHTLY != 1, not a release branch)"
          echo "To enable upload, set 'Upload Wheels to S3' to 'Yes' in the build configuration"
          exit 0
        fi

        echo "Upload enabled, proceeding..."

        # Get configuration from meta-data with defaults
        ROCM_PUBLISH_ONLY="$$(buildkite-agent meta-data get rocm-publish-only 2>/dev/null || echo '')"
        ROCM_PUBLISH_ONLY="$${ROCM_PUBLISH_ONLY:-false}"

        ROCM_PREVIOUS_BUILD_ID="$$(buildkite-agent meta-data get rocm-previous-build-id 2>/dev/null || echo '')"

        if [ "$${ROCM_PUBLISH_ONLY}" = "true" ] && [ -n "$${ROCM_PREVIOUS_BUILD_ID}" ]; then
          echo "Downloading all artifacts from previous build: $${ROCM_PREVIOUS_BUILD_ID}"
          buildkite-agent artifact download "artifacts/rocm-base-wheels/*.whl" . --build "$${ROCM_PREVIOUS_BUILD_ID}"
          buildkite-agent artifact download "artifacts/rocm-vllm-wheel/*.whl" . --build "$${ROCM_PREVIOUS_BUILD_ID}"
        else
          echo "Downloading artifacts from current build"
          buildkite-agent artifact download "artifacts/rocm-base-wheels/*.whl" .
          buildkite-agent artifact download "artifacts/rocm-vllm-wheel/*.whl" .
        fi

        # Run upload script
        bash .buildkite/scripts/upload-rocm-wheels.sh
    env:
      DOCKER_BUILDKIT: "1"
      S3_BUCKET: "vllm-rocm-wheels-embeddedllm-2"
      AWS_DEFAULT_REGION: "us-east-1"

  # # ROCm Job 4: Build ROCm Release Image (x86_64 only)
  # - label: ":docker: Build ROCm release image (x86_64)"
  #   id: build-rocm-release-image-x86
  #   depends_on:
  #     - step: build-rocm-vllm-wheel
  #       allow_failure: false
  #   agents:
  #     queue: vllm-rocm-wheel
  #   timeout_in_minutes: 120
  #   commands:
  #     # Download wheel artifacts
  #     - buildkite-agent artifact download "artifacts/rocm-base-wheels/*.whl" .
  #     - buildkite-agent artifact download "artifacts/rocm-vllm-wheel/*.whl" .
  #     - buildkite-agent artifact download "artifacts/rocm-docker-image/rocm-base-image.tar.gz" .

  #     # Load base image
  #     - |
  #       gunzip -c artifacts/rocm-docker-image/rocm-base-image.tar.gz | docker load
  #       docker tag rocm/vllm-dev:base-* rocm/vllm-dev:base 2>/dev/null || docker tag $(docker images rocm/vllm-dev --format "{{.Repository}}:{{.Tag}}" | head -1) rocm/vllm-dev:base

  #     # Prepare context
  #     - |
  #       mkdir -p docker/context/base-wheels
  #       cp artifacts/rocm-base-wheels/*.whl docker/context/base-wheels/
  #       touch docker/context/base-wheels/.keep

  #     # Build final image
  #     - |
  #       export ROCM_VLLM_VERSION="$(buildkite-agent meta-data get rocm-resolved-vllm-version 2>/dev/null || echo 'main')"
  #       export PYTORCH_ROCM_ARCH="${PYTORCH_ROCM_ARCH:-$(buildkite-agent meta-data get rocm-pytorch-rocm-arch 2>/dev/null || echo 'gfx90a;gfx942')}"
  #       aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7
  #       DOCKER_BUILDKIT=1 docker build \
  #         --file docker/Dockerfile.rocm \
  #         --target final \
  #         --tag public.ecr.aws/q9t5s3a7/vllm-rocm-release-repo:${BUILDKITE_COMMIT} \
  #         --tag public.ecr.aws/q9t5s3a7/vllm-rocm-release-repo:latest \
  #         --build-arg BASE_IMAGE=rocm/vllm-dev:base \
  #         --build-arg ARG_PYTORCH_ROCM_ARCH="${PYTORCH_ROCM_ARCH}" \
  #         --build-arg REMOTE_VLLM=1 \
  #         --build-arg VLLM_BRANCH="${ROCM_VLLM_VERSION}" \
  #         .
  #       # docker push public.ecr.aws/q9t5s3a7/vllm-rocm-release-repo:${BUILDKITE_COMMIT}
  #       # docker push public.ecr.aws/q9t5s3a7/vllm-rocm-release-repo:latest
  #   env:
  #     DOCKER_BUILDKIT: "1"

  # # ROCm Job 5: Publish ROCm nightly image to DockerHub
  # - label: ":docker: Publish ROCm nightly to DockerHub"
  #   id: publish-rocm-dockerhub
  #   depends_on:
  #     - build-rocm-release-image-x86
  #   if: build.env("NIGHTLY") == "1"
  #   agents:
  #     queue: vllm-rocm-wheel
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "docker pull public.ecr.aws/q9t5s3a7/vllm-rocm-release-repo:$BUILDKITE_COMMIT"
  #     - "docker tag public.ecr.aws/q9t5s3a7/vllm-rocm-release-repo:$BUILDKITE_COMMIT vllm/vllm-rocm:nightly"
  #     - "docker tag public.ecr.aws/q9t5s3a7/vllm-rocm-release-repo:$BUILDKITE_COMMIT vllm/vllm-rocm:nightly-$BUILDKITE_COMMIT"
  #     - "docker push vllm/vllm-rocm:nightly"
  #     - "docker push vllm/vllm-rocm:nightly-$BUILDKITE_COMMIT"
  #     Clean up old nightly builds (keep only last 14)
  #     - "bash .buildkite/scripts/cleanup-rocm-nightly-builds.sh || true"
  #   plugins:
  #     - docker-login#v3.0.0:
  #         username: vllmbot
  #         password-env: DOCKERHUB_TOKEN
  #   env:
  #     DOCKER_BUILDKIT: "1"
  #     DOCKERHUB_USERNAME: "vllmbot"

  # # ROCm Job 6: Annotate ROCm Release
  # - label: ":memo: Annotate ROCm release workflow"
  #   id: annotate-rocm-release
  #   depends_on:
  #     - step: upload-rocm-wheels
  #       allow_failure: true
  #     - step: build-rocm-release-image-x86
  #       allow_failure: true
  #   agents:
  #     queue: vllm-rocm-wheel
  #   commands:
  #     - "bash .buildkite/scripts/annotate-rocm-release.sh"
